<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Aditya Arora" />
  <title>SAMPLE_CODE.html</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="shortcut icon" href="https://arora-aditya.com/images/A2.png" type="img">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137390799-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-137390799-2');
    window.onload = function(){
      let num = window.location.pathname.slice(window.location.pathname.length-3, window.location.pathname.length-1);
      if(parseInt(num) >= 33){
      document.getElementById('button').parentNode.removeChild(document.getElementById('button'));
      }
    }
  
    function next(){
      var num = window.location.pathname.slice(window.location.pathname.length-7, window.location.pathname.length-5);
      var next= String(parseInt(num)+1);
      if(next.length < 2){
        next = "0" + next
      }
      if(parseInt(num) < 33){
        // string manipulation to handle edge case for L"25" conflicting with "25"2 in header
        window.location.pathname = window.location.pathname.slice(0, window.location.pathname.length-7) + window.location.pathname.slice(window.location.pathname.length-7).replace(num, next);
      }
    }
  </script>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#producer-consumers">Producer / Consumers</a></li>
<li><a href="#inotify"><code>inotify</code></a></li>
<li><a href="#flock"><code>flock</code></a></li>
<li><a href="#fcntl"><code>fcntl</code></a></li>
<li><a href="#fork"><code>fork</code></a></li>
<li><a href="#sockets"><code>sockets</code></a><ul>
<li><a href="#client">client</a></li>
<li><a href="#server">server</a></li>
</ul></li>
<li><a href="#basic-curl">basic <code>cURL</code></a></li>
<li><a href="#curlm"><code>curlM</code></a></li>
<li><a href="#inotify-1"><code>inotify</code></a></li>
<li><a href="#pcond"><code>pcond</code></a></li>
<li><a href="#select"><code>select</code></a></li>
<li><a href="#poll"><code>poll</code></a></li>
<li><a href="#aiocb"><code>aiocb</code></a><ul>
<li><a href="#simple">simple</a></li>
<li><a href="#callbacks">callbacks</a></li>
</ul></li>
<li><a href="#libevent"><code>libevent</code></a><ul>
<li><a href="#no-buffer">no buffer</a></li>
<li><a href="#buffered">buffered</a></li>
</ul></li>
</ul>
</nav>
<h2 id="producer-consumers">Producer / Consumers</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="pp">#include </span><span class="im">&lt;pthread.h&gt;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="pp">#include </span><span class="im">&lt;math.h&gt;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="pp">#include </span><span class="im">&lt;semaphore.h&gt;</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="pp">#define BUFFER_SIZE 100</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="dt">int</span> buffer[BUFFER_SIZE];</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="dt">int</span> pindex = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="dt">int</span> cindex = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-11" title="11">sem_t spaces;</a>
<a class="sourceLine" id="cb1-12" title="12">sem_t items;</a>
<a class="sourceLine" id="cb1-13" title="13">pthread_mutex_t mutex;</a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="dt">int</span> produce( <span class="dt">int</span> id ) {</a>
<a class="sourceLine" id="cb1-16" title="16">  <span class="dt">int</span> r = rand();</a>
<a class="sourceLine" id="cb1-17" title="17">  printf(<span class="st">&quot;Producer %d produced %d.</span><span class="sc">\n</span><span class="st">&quot;</span>, id, r);</a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="cf">return</span> r;</a>
<a class="sourceLine" id="cb1-19" title="19">}</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="dt">void</span> consume( <span class="dt">int</span> id, <span class="dt">int</span> number ) {</a>
<a class="sourceLine" id="cb1-22" title="22">  printf(<span class="st">&quot;Consumer %d consumed %d.</span><span class="sc">\n</span><span class="st">&quot;</span>, id, number);</a>
<a class="sourceLine" id="cb1-23" title="23">}</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="dt">void</span>* producer( <span class="dt">void</span>* arg ) {</a>
<a class="sourceLine" id="cb1-26" title="26">  <span class="dt">int</span>* id = (<span class="dt">int</span>*) arg;</a>
<a class="sourceLine" id="cb1-27" title="27">  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10000</span>; ++i) {</a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="dt">int</span> num = produce(*id);</a>
<a class="sourceLine" id="cb1-29" title="29">    sem_wait( &amp;spaces );</a>
<a class="sourceLine" id="cb1-30" title="30">    pthread_mutex_lock( &amp;mutex );</a>
<a class="sourceLine" id="cb1-31" title="31">    buffer[pindex] = num;</a>
<a class="sourceLine" id="cb1-32" title="32">    pindex = (pindex + <span class="dv">1</span>) % BUFFER_SIZE;</a>
<a class="sourceLine" id="cb1-33" title="33">    pthread_mutex_unlock( &amp;mutex );</a>
<a class="sourceLine" id="cb1-34" title="34">    sem_post( &amp;items );</a>
<a class="sourceLine" id="cb1-35" title="35">  }</a>
<a class="sourceLine" id="cb1-36" title="36">  free( arg );</a>
<a class="sourceLine" id="cb1-37" title="37">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb1-38" title="38">}</a>
<a class="sourceLine" id="cb1-39" title="39"></a>
<a class="sourceLine" id="cb1-40" title="40"><span class="dt">void</span>* consumer( <span class="dt">void</span>* arg ) {</a>
<a class="sourceLine" id="cb1-41" title="41">  <span class="dt">int</span>* id = (<span class="dt">int</span>*) arg;</a>
<a class="sourceLine" id="cb1-42" title="42">  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10000</span>; ++i) {</a>
<a class="sourceLine" id="cb1-43" title="43">    sem_wait( &amp;items );</a>
<a class="sourceLine" id="cb1-44" title="44">    pthread_mutex_lock( &amp;mutex );</a>
<a class="sourceLine" id="cb1-45" title="45">    <span class="dt">int</span> num = buffer[cindex];</a>
<a class="sourceLine" id="cb1-46" title="46">    buffer[cindex] = -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-47" title="47">    cindex = (cindex + <span class="dv">1</span>) % BUFFER_SIZE;</a>
<a class="sourceLine" id="cb1-48" title="48">    pthread_mutex_unlock( &amp;mutex );</a>
<a class="sourceLine" id="cb1-49" title="49">    sem_post( &amp;spaces );</a>
<a class="sourceLine" id="cb1-50" title="50">    consume( *id, num );</a>
<a class="sourceLine" id="cb1-51" title="51">  }</a>
<a class="sourceLine" id="cb1-52" title="52">  free( id );</a>
<a class="sourceLine" id="cb1-53" title="53">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb1-54" title="54">}</a>
<a class="sourceLine" id="cb1-55" title="55"></a>
<a class="sourceLine" id="cb1-56" title="56"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb1-57" title="57">  sem_init( &amp;spaces, <span class="dv">0</span>, BUFFER_SIZE );</a>
<a class="sourceLine" id="cb1-58" title="58">  sem_init( &amp;items, <span class="dv">0</span>, <span class="dv">0</span> );</a>
<a class="sourceLine" id="cb1-59" title="59">  pthread_mutex_init( &amp;mutex, NULL );</a>
<a class="sourceLine" id="cb1-60" title="60"></a>
<a class="sourceLine" id="cb1-61" title="61">  pthread_t threads[<span class="dv">20</span>];</a>
<a class="sourceLine" id="cb1-62" title="62"></a>
<a class="sourceLine" id="cb1-63" title="63">  <span class="cf">for</span>( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; i++ ) {</a>
<a class="sourceLine" id="cb1-64" title="64">    <span class="dt">int</span> * id = malloc(<span class="kw">sizeof</span>(<span class="dt">int</span>));</a>
<a class="sourceLine" id="cb1-65" title="65">    * id = i;</a>
<a class="sourceLine" id="cb1-66" title="66">    pthread_create(&amp;threads[i], NULL, producer, id);</a>
<a class="sourceLine" id="cb1-67" title="67">  }</a>
<a class="sourceLine" id="cb1-68" title="68">  <span class="cf">for</span>( <span class="dt">int</span> j = <span class="dv">10</span>; j &lt; <span class="dv">20</span>; j++ ) {</a>
<a class="sourceLine" id="cb1-69" title="69">    <span class="dt">int</span> * jd = malloc(<span class="kw">sizeof</span>(<span class="dt">int</span>));</a>
<a class="sourceLine" id="cb1-70" title="70">    * jd = j-<span class="dv">10</span>;</a>
<a class="sourceLine" id="cb1-71" title="71">    pthread_create(&amp;threads[j], NULL, consumer, jd);</a>
<a class="sourceLine" id="cb1-72" title="72">  }</a>
<a class="sourceLine" id="cb1-73" title="73">  <span class="cf">for</span>( <span class="dt">int</span> k = <span class="dv">0</span>; k &lt; <span class="dv">20</span>; k++ ){</a>
<a class="sourceLine" id="cb1-74" title="74">    pthread_join(threads[k], NULL);</a>
<a class="sourceLine" id="cb1-75" title="75">  }</a>
<a class="sourceLine" id="cb1-76" title="76">  sem_destroy( &amp;spaces );</a>
<a class="sourceLine" id="cb1-77" title="77">  sem_destroy( &amp;items );</a>
<a class="sourceLine" id="cb1-78" title="78">  pthread_mutex_destroy( &amp;mutex );</a>
<a class="sourceLine" id="cb1-79" title="79">  pthread_exit( <span class="dv">0</span> );</a>
<a class="sourceLine" id="cb1-80" title="80">}</a></code></pre></div>
<h2 id="inotify"><code>inotify</code></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="pp">#include </span><span class="im">&lt;sys/inotify.h&gt;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="dt">const</span> <span class="dt">char</span> filename[] = <span class="st">&quot;file.lock&quot;</span>;</a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="dt">int</span> lockFD;</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="dt">bool</span> our_turn = false;</a>
<a class="sourceLine" id="cb2-14" title="14"></a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="cf">while</span>( !our_turn ) {</a>
<a class="sourceLine" id="cb2-16" title="16">        lockFD = open( filename, O_CREAT | O_EXCL | O_TRUNC );</a>
<a class="sourceLine" id="cb2-17" title="17">        <span class="cf">if</span> ( lockFD == -<span class="dv">1</span> ) {</a>
<a class="sourceLine" id="cb2-18" title="18">            printf( <span class="st">&quot;The lock file exists and process %ld will wait its turn...</span><span class="sc">\n</span><span class="st">&quot;</span>, getpid() );</a>
<a class="sourceLine" id="cb2-19" title="19">            <span class="dt">int</span> notifyFD = inotify_init( );</a>
<a class="sourceLine" id="cb2-20" title="20">            <span class="dt">uint32_t</span> watched = inotify_add_watch( notifyFD, filename, IN_DELETE_SELF );</a>
<a class="sourceLine" id="cb2-21" title="21"></a>
<a class="sourceLine" id="cb2-22" title="22">            <span class="co">/* Read the file descriptor for the notify -- we get blocked here</span></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="co">               until there&#39;s an event that we want */</span></a>
<a class="sourceLine" id="cb2-24" title="24">            <span class="dt">int</span> buffer_size = <span class="kw">sizeof</span>( <span class="kw">struct</span> inotify_event ) + strlen( filename ) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb2-25" title="25">            <span class="dt">char</span>* event_buffer = malloc( buffer_size );</a>
<a class="sourceLine" id="cb2-26" title="26">            printf(<span class="st">&quot;Setup complete, waiting for event...</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-27" title="27">            read( notifyFD, event_buffer, buffer_size );</a>
<a class="sourceLine" id="cb2-28" title="28"></a>
<a class="sourceLine" id="cb2-29" title="29">            <span class="kw">struct</span> inotify_event* event = (<span class="kw">struct</span> inotify_event*) event_buffer;</a>
<a class="sourceLine" id="cb2-30" title="30">            <span class="co">/* Here we can look and see what arrived and decide what to do.</span></a>
<a class="sourceLine" id="cb2-31" title="31"><span class="co">               In this example, we&#39;re only watching one file and one type</span></a>
<a class="sourceLine" id="cb2-32" title="32"><span class="co">               of event, so we don&#39;t need to make any decisions now */</span></a>
<a class="sourceLine" id="cb2-33" title="33"></a>
<a class="sourceLine" id="cb2-34" title="34">            printf(<span class="st">&quot;Event occurred!</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb2-35" title="35"></a>
<a class="sourceLine" id="cb2-36" title="36">            free( event_buffer );</a>
<a class="sourceLine" id="cb2-37" title="37">            inotify_rm_watch( lockFD, watched );</a>
<a class="sourceLine" id="cb2-38" title="38">            close( notifyFD );</a>
<a class="sourceLine" id="cb2-39" title="39">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb2-40" title="40">            <span class="dt">char</span>* pid = malloc( <span class="dv">32</span> );</a>
<a class="sourceLine" id="cb2-41" title="41">            memset( pid, <span class="dv">0</span>, <span class="dv">32</span> );</a>
<a class="sourceLine" id="cb2-42" title="42">            <span class="dt">int</span> bytes_of_pid = sprintf( pid, <span class="st">&quot;%ld&quot;</span>, getpid() );</a>
<a class="sourceLine" id="cb2-43" title="43"></a>
<a class="sourceLine" id="cb2-44" title="44">            write( lockFD, pid, bytes_of_pid );</a>
<a class="sourceLine" id="cb2-45" title="45">            free ( pid );</a>
<a class="sourceLine" id="cb2-46" title="46">            close( lockFD );</a>
<a class="sourceLine" id="cb2-47" title="47">            our_turn = true;</a>
<a class="sourceLine" id="cb2-48" title="48">        }</a>
<a class="sourceLine" id="cb2-49" title="49">    }</a>
<a class="sourceLine" id="cb2-50" title="50"></a>
<a class="sourceLine" id="cb2-51" title="51">    printf(<span class="st">&quot;Process %ld is in the area protected by file lock.</span><span class="sc">\n</span><span class="st">&quot;</span>, getpid());</a>
<a class="sourceLine" id="cb2-52" title="52">    remove( filename );</a>
<a class="sourceLine" id="cb2-53" title="53">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-54" title="54">}</a></code></pre></div>
<h2 id="flock"><code>flock</code></h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">FILE</span>* f = fopen(<span class="st">&quot;myfile.txt&quot;</span>, <span class="st">&quot;r&quot;</span>);</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="dt">int</span> file_desc = fileno( f );</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="dt">int</span> result = flock( file_desc, LOCK_EX );</a></code></pre></div>
<h2 id="fcntl"><code>fcntl</code></h2>
<p>The first example is how to lock a file and then how to unlock it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" title="1"><span class="dt">int</span> write_lock_file( <span class="dt">int</span> file_descriptor ) {</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="kw">struct</span> flock fl;</a>
<a class="sourceLine" id="cb4-4" title="4">  fl.l_type = F_WRLOCK;</a>
<a class="sourceLine" id="cb4-5" title="5">  fl.l_start = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-6" title="6">  fl.l_whence = SEEK_SET;</a>
<a class="sourceLine" id="cb4-7" title="7">  fl.l_len = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="cf">return</span> fcntl( fd, F_SETLK, &amp;fl );</a>
<a class="sourceLine" id="cb4-10" title="10">}</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="dt">int</span> unlock_file( <span class="dt">int</span> file_descriptor ) {</a>
<a class="sourceLine" id="cb4-13" title="13"></a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="kw">struct</span> flock fl;</a>
<a class="sourceLine" id="cb4-15" title="15">  fl.l_type = F_UNLCK;</a>
<a class="sourceLine" id="cb4-16" title="16">  fl.l_start = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-17" title="17">  fl.l_whence = SEEK_SET;</a>
<a class="sourceLine" id="cb4-18" title="18">  fl.l_len = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-19" title="19"></a>
<a class="sourceLine" id="cb4-20" title="20">  <span class="cf">return</span> fcntl( fd, F_SETLK, &amp;fl );</a>
<a class="sourceLine" id="cb4-21" title="21">}</a></code></pre></div>
<p>checking if a given part of a file is locked:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1"><span class="dt">int</span> fd = open ( <span class="st">&quot;example.txt&quot;</span>, O_RDONLY );</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">struct</span> flock lock;</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4">lock.l_type = F_RDLOCK;</a>
<a class="sourceLine" id="cb5-5" title="5">lock.l_start = <span class="dv">1024</span>;</a>
<a class="sourceLine" id="cb5-6" title="6">lock.l_whence = SEEK_SET;</a>
<a class="sourceLine" id="cb5-7" title="7">lock.l_len = <span class="dv">256</span>;</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9">fcntl( fd, F_GETLK, &amp;lock );</a>
<a class="sourceLine" id="cb5-10" title="10"><span class="cf">if</span> ( lock.l_type == F_UNLCK ) {</a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="co">/* Lock is unlocked; we may proceed */</span></a>
<a class="sourceLine" id="cb5-12" title="12">} <span class="cf">else</span> <span class="cf">if</span> ( lock.l_type = F_WRLOCK ) {</a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="co">/* File is write locked by a different process */</span></a>
<a class="sourceLine" id="cb5-14" title="14">  printf( <span class="st">&quot;File locked by process ID %d.</span><span class="sc">\n</span><span class="st">&quot;</span>, lock.l_pid );</a>
<a class="sourceLine" id="cb5-15" title="15">  <span class="cf">return</span> -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb5-16" title="16">}</a></code></pre></div>
<h2 id="fork"><code>fork</code></h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1"><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb6-6" title="6">  pid_t pid;</a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="dt">int</span> childStatus;</a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="co">/* fork a child process */</span></a>
<a class="sourceLine" id="cb6-10" title="10">  pid = fork();</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="cf">if</span> (pid &lt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-13" title="13">    <span class="co">/* error occurred */</span></a>
<a class="sourceLine" id="cb6-14" title="14">    fprintf(stderr, <span class="st">&quot;Fork Failed&quot;</span>);</a>
<a class="sourceLine" id="cb6-15" title="15">    <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb6-16" title="16"></a>
<a class="sourceLine" id="cb6-17" title="17"> } <span class="cf">else</span> <span class="cf">if</span> (pid == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-18" title="18">    <span class="co">/* child process */</span></a>
<a class="sourceLine" id="cb6-19" title="19">    execlp(<span class="st">&quot;/bin/ls&quot;</span>,<span class="st">&quot;ls&quot;</span>,NULL);</a>
<a class="sourceLine" id="cb6-20" title="20"></a>
<a class="sourceLine" id="cb6-21" title="21">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb6-22" title="22">    <span class="co">/* parent process */</span></a>
<a class="sourceLine" id="cb6-23" title="23">    <span class="co">/* parent will wait for the child to complete */</span></a>
<a class="sourceLine" id="cb6-24" title="24">    wait(&amp;childStatus);</a>
<a class="sourceLine" id="cb6-25" title="25">    printf(<span class="st">&quot;Child Complete with status: %i </span><span class="sc">\n</span><span class="st">&quot;</span>, childStatus);</a>
<a class="sourceLine" id="cb6-26" title="26"></a>
<a class="sourceLine" id="cb6-27" title="27">  }</a>
<a class="sourceLine" id="cb6-28" title="28"></a>
<a class="sourceLine" id="cb6-29" title="29">  <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-30" title="30">}</a></code></pre></div>
<h2 id="sockets"><code>sockets</code></h2>
<h3 id="client">client</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">struct</span> addrinfo hints;</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">struct</span> addrinfo *serverinfo;  <span class="co">// will point to the results</span></a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4">memset(&amp;hints, <span class="dv">0</span>, <span class="kw">sizeof</span> hints); <span class="co">// make sure the struct is empty</span></a>
<a class="sourceLine" id="cb7-5" title="5">hints.ai_family = AF_INET;     <span class="co">// Choose IPv4</span></a>
<a class="sourceLine" id="cb7-6" title="6">hints.ai_socktype = SOCK_STREAM; <span class="co">// TCP stream sockets</span></a>
<a class="sourceLine" id="cb7-7" title="7">hints.ai_flags = AI_PASSIVE;     <span class="co">// fill in my IP for me</span></a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="dt">int</span> result = getaddrinfo(<span class="st">&quot;www.example.com&quot;</span>, <span class="st">&quot;2520&quot;</span>, &amp;hints, &amp;serverinfo);</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="cf">if</span> (result != <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="cf">return</span> -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb7-12" title="12">}</a>
<a class="sourceLine" id="cb7-13" title="13"><span class="kw">struct</span> sockaddr_in * sain = (<span class="kw">struct</span> sockaddr_in*) serverinfo-&gt;ai_addr;</a>
<a class="sourceLine" id="cb7-14" title="14"><span class="co">/* Do things with this */</span></a>
<a class="sourceLine" id="cb7-15" title="15"></a>
<a class="sourceLine" id="cb7-16" title="16">freeaddrinfo( serverinfo );</a></code></pre></div>
<p>OR with getaddrinfo</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">struct</span> addrinfo hints;</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">struct</span> addrinfo *res;</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="dt">int</span> sockfd;</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">memset(&amp;hints, <span class="dv">0</span>, <span class="kw">sizeof</span>( hints ));</a>
<a class="sourceLine" id="cb8-6" title="6">hints.ai_family = AF_INET;</a>
<a class="sourceLine" id="cb8-7" title="7">hints.ai_socktype = SOCK_STREAM;</a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9">getaddrinfo(<span class="st">&quot;www.uwaterloo.ca&quot;</span>, <span class="st">&quot;80&quot;</span>, &amp;hints, &amp;res);</a>
<a class="sourceLine" id="cb8-10" title="10">sockfd = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</a>
<a class="sourceLine" id="cb8-11" title="11"></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="dt">int</span> status = connect(sockfd, res-&gt;ai_addr, res-&gt;ai_addrlen);</a></code></pre></div>
<h3 id="server">server</h3>
<p>skipping the error checking for compactness :</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">struct</span> sockaddr_in client_addr;</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="dt">int</span> client_addr_size = <span class="kw">sizeof</span>( <span class="kw">struct</span> sockaddr_in );</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="dt">int</span> newsockfd;</a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="dt">int</span> socketfd = socket( AF_INET, SOCK_STREAM, <span class="dv">0</span> );</a>
<a class="sourceLine" id="cb9-6" title="6"><span class="kw">struct</span> sockaddr_in server_addr;</a>
<a class="sourceLine" id="cb9-7" title="7">server_addr.sin_family = AF_INET;</a>
<a class="sourceLine" id="cb9-8" title="8">server_addr.sin_port = htons( <span class="dv">2520</span> );</a>
<a class="sourceLine" id="cb9-9" title="9">server_addr.sin_addr.s_addr = htonl( INADDR_ANY );</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11">bind( socketfd, (<span class="kw">struct</span> sockaddr*) &amp;server_addr, <span class="kw">sizeof</span>( server_addr ));</a>
<a class="sourceLine" id="cb9-12" title="12">listen( socketfd, <span class="dv">5</span> );</a>
<a class="sourceLine" id="cb9-13" title="13">newsockfd = accept( socktfd, (<span class="kw">struct</span> sockaddr*) &amp;client_addr, &amp;client_addr_size );</a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co">/* Do something useful */</span></a>
<a class="sourceLine" id="cb9-16" title="16"></a>
<a class="sourceLine" id="cb9-17" title="17">close( newsockfd );</a>
<a class="sourceLine" id="cb9-18" title="18"></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">/* Later when all is done */</span></a>
<a class="sourceLine" id="cb9-20" title="20">close( socketfd );</a></code></pre></div>
<h2 id="basic-curl">basic <code>cURL</code></h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb10-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="pp">#include </span><span class="im">&lt;curl/curl.h&gt;</span></a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb10-5" title="5">  CURL *curl;</a>
<a class="sourceLine" id="cb10-6" title="6">  CURLcode res;</a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8">  curl_global_init(CURL_GLOBAL_DEFAULT);</a>
<a class="sourceLine" id="cb10-9" title="9"></a>
<a class="sourceLine" id="cb10-10" title="10">  curl = curl_easy_init();</a>
<a class="sourceLine" id="cb10-11" title="11">  <span class="cf">if</span>( curl ) {</a>
<a class="sourceLine" id="cb10-12" title="12">    curl_easy_setopt(curl, CURLOPT_URL, <span class="st">&quot;https://example.com/&quot;</span> );</a>
<a class="sourceLine" id="cb10-13" title="13">    res = curl_easy_perform(curl);</a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15">  <span class="cf">if</span>( res != CURLE_OK) {</a>
<a class="sourceLine" id="cb10-16" title="16">      fprintf(stderr, <span class="st">&quot;curl_easy_perform() failed: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, curl_easy_strerror(res));</a>
<a class="sourceLine" id="cb10-17" title="17">    }</a>
<a class="sourceLine" id="cb10-18" title="18">    curl_easy_cleanup(curl);</a>
<a class="sourceLine" id="cb10-19" title="19">  }</a>
<a class="sourceLine" id="cb10-20" title="20"></a>
<a class="sourceLine" id="cb10-21" title="21">  curl_global_cleanup();</a>
<a class="sourceLine" id="cb10-22" title="22">  <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb10-23" title="23">}</a></code></pre></div>
<h2 id="curlm"><code>curlM</code></h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb11-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="pp">#include </span><span class="im">&lt;curl/multi.h&gt;</span></a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="pp">#define MAX_WAIT_MSECS 30*1000 </span><span class="co">/* Wait max. 30 seconds */</span></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="dt">const</span> <span class="dt">char</span> *urls[] = {</a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="st">&quot;http://www.microsoft.com&quot;</span>,</a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="st">&quot;http://www.yahoo.com&quot;</span>,</a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="st">&quot;http://www.wikipedia.org&quot;</span>,</a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="st">&quot;http://slashdot.org&quot;</span></a>
<a class="sourceLine" id="cb11-13" title="13">};</a>
<a class="sourceLine" id="cb11-14" title="14"><span class="pp">#define CNT 4</span></a>
<a class="sourceLine" id="cb11-15" title="15"></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="dt">size_t</span> cb(<span class="dt">char</span> *d, <span class="dt">size_t</span> n, <span class="dt">size_t</span> l, <span class="dt">void</span> *p) {</a>
<a class="sourceLine" id="cb11-17" title="17">  <span class="co">/* take care of the data here, ignored in this example */</span></a>
<a class="sourceLine" id="cb11-18" title="18">  <span class="cf">return</span> n*l;</a>
<a class="sourceLine" id="cb11-19" title="19">}</a>
<a class="sourceLine" id="cb11-20" title="20"></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="dt">void</span> init( CURLM *cm, <span class="dt">int</span> i ) {</a>
<a class="sourceLine" id="cb11-22" title="22">  CURL *eh = curl_easy_init();</a>
<a class="sourceLine" id="cb11-23" title="23">  curl_easy_setopt( eh, CURLOPT_WRITEFUNCTION, cb );</a>
<a class="sourceLine" id="cb11-24" title="24">  curl_easy_setopt( eh, CURLOPT_HEADER, <span class="dv">0</span><span class="bu">L</span> );</a>
<a class="sourceLine" id="cb11-25" title="25">  curl_easy_setopt( eh, CURLOPT_URL, urls[i] );</a>
<a class="sourceLine" id="cb11-26" title="26">  curl_easy_setopt( eh, CURLOPT_PRIVATE, urls[i]) ;</a>
<a class="sourceLine" id="cb11-27" title="27">  curl_easy_setopt( eh, CURLOPT_VERBOSE, <span class="dv">0</span><span class="bu">L</span> );</a>
<a class="sourceLine" id="cb11-28" title="28">  curl_multi_add_handle( cm, eh );</a>
<a class="sourceLine" id="cb11-29" title="29">}</a>
<a class="sourceLine" id="cb11-30" title="30"></a>
<a class="sourceLine" id="cb11-31" title="31"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb11-32" title="32">    CURLM *cm = NULL;</a>
<a class="sourceLine" id="cb11-33" title="33">    CURL *eh = NULL;</a>
<a class="sourceLine" id="cb11-34" title="34">    CURLMsg *msg = NULL;</a>
<a class="sourceLine" id="cb11-35" title="35">    CURLcode return_code = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-36" title="36">    <span class="dt">int</span> still_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-37" title="37">    <span class="dt">int</span> msgs_left = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-38" title="38">    <span class="dt">int</span> http_status_code;</a>
<a class="sourceLine" id="cb11-39" title="39">    <span class="dt">const</span> <span class="dt">char</span> *szUrl;</a>
<a class="sourceLine" id="cb11-40" title="40"></a>
<a class="sourceLine" id="cb11-41" title="41">    curl_global_init( CURL_GLOBAL_ALL );</a>
<a class="sourceLine" id="cb11-42" title="42">    cm = curl_multi_init( );</a>
<a class="sourceLine" id="cb11-43" title="43"></a>
<a class="sourceLine" id="cb11-44" title="44">    <span class="cf">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; CNT; ++i ) {</a>
<a class="sourceLine" id="cb11-45" title="45">        init( cm, i );</a>
<a class="sourceLine" id="cb11-46" title="46">    }</a>
<a class="sourceLine" id="cb11-47" title="47"></a>
<a class="sourceLine" id="cb11-48" title="48">    curl_multi_perform( cm, &amp;still_running );</a>
<a class="sourceLine" id="cb11-49" title="49"></a>
<a class="sourceLine" id="cb11-50" title="50">    <span class="cf">do</span> {</a>
<a class="sourceLine" id="cb11-51" title="51">        <span class="dt">int</span> numfds = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-52" title="52">        <span class="dt">int</span> res = curl_multi_wait( cm, NULL, <span class="dv">0</span>, MAX_WAIT_MSECS, &amp;numfds );</a>
<a class="sourceLine" id="cb11-53" title="53">        <span class="cf">if</span>( res != CURLM_OK ) {</a>
<a class="sourceLine" id="cb11-54" title="54">            fprintf( stderr, <span class="st">&quot;error: curl_multi_wait() returned %d</span><span class="sc">\n</span><span class="st">&quot;</span>, res );</a>
<a class="sourceLine" id="cb11-55" title="55">            <span class="cf">return</span> EXIT_FAILURE;</a>
<a class="sourceLine" id="cb11-56" title="56">        }</a>
<a class="sourceLine" id="cb11-57" title="57">        curl_multi_perform( cm, &amp;still_running );</a>
<a class="sourceLine" id="cb11-58" title="58"></a>
<a class="sourceLine" id="cb11-59" title="59">    } <span class="cf">while</span>( still_running );</a>
<a class="sourceLine" id="cb11-60" title="60"></a>
<a class="sourceLine" id="cb11-61" title="61">    <span class="cf">while</span> ( ( msg = curl_multi_info_read( cm, &amp;msgs_left ) ) ) {</a>
<a class="sourceLine" id="cb11-62" title="62">        <span class="cf">if</span> ( msg-&gt;msg == CURLMSG_DONE ) {</a>
<a class="sourceLine" id="cb11-63" title="63">            eh = msg-&gt;easy_handle;</a>
<a class="sourceLine" id="cb11-64" title="64"></a>
<a class="sourceLine" id="cb11-65" title="65">            return_code = msg-&gt;data.result;</a>
<a class="sourceLine" id="cb11-66" title="66">            <span class="cf">if</span> ( return_code != CURLE_OK ) {</a>
<a class="sourceLine" id="cb11-67" title="67">                fprintf( stderr, <span class="st">&quot;CURL error code: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, msg-&gt;data.result );</a>
<a class="sourceLine" id="cb11-68" title="68">                <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb11-69" title="69">            }</a>
<a class="sourceLine" id="cb11-70" title="70"></a>
<a class="sourceLine" id="cb11-71" title="71">            <span class="co">// Get HTTP status code</span></a>
<a class="sourceLine" id="cb11-72" title="72">            http_status_code = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-73" title="73">            szUrl = NULL;</a>
<a class="sourceLine" id="cb11-74" title="74"></a>
<a class="sourceLine" id="cb11-75" title="75">            curl_easy_getinfo( eh, CURLINFO_RESPONSE_CODE, &amp;http_status_code );</a>
<a class="sourceLine" id="cb11-76" title="76">            curl_easy_getinfo( eh, CURLINFO_PRIVATE, &amp;szUrl );</a>
<a class="sourceLine" id="cb11-77" title="77"></a>
<a class="sourceLine" id="cb11-78" title="78">            <span class="cf">if</span>( http_status_code == <span class="dv">200</span> ) {</a>
<a class="sourceLine" id="cb11-79" title="79">                printf( <span class="st">&quot;200 OK for %s</span><span class="sc">\n</span><span class="st">&quot;</span>, szUrl ) ;</a>
<a class="sourceLine" id="cb11-80" title="80">            } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-81" title="81">                fprintf( stderr, <span class="st">&quot;GET of %s returned http status code %d</span><span class="sc">\n</span><span class="st">&quot;</span>, szUrl, http_status_code );</a>
<a class="sourceLine" id="cb11-82" title="82">            }</a>
<a class="sourceLine" id="cb11-83" title="83"></a>
<a class="sourceLine" id="cb11-84" title="84">            curl_multi_remove_handle( cm, eh );</a>
<a class="sourceLine" id="cb11-85" title="85">            curl_easy_cleanup( eh );</a>
<a class="sourceLine" id="cb11-86" title="86">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-87" title="87">            fprintf( stderr, <span class="st">&quot;error: after curl_multi_info_read(), CURLMsg=%d</span><span class="sc">\n</span><span class="st">&quot;</span>, msg-&gt;msg );</a>
<a class="sourceLine" id="cb11-88" title="88">        }</a>
<a class="sourceLine" id="cb11-89" title="89">    }</a>
<a class="sourceLine" id="cb11-90" title="90">    curl_multi_cleanup( cm );</a>
<a class="sourceLine" id="cb11-91" title="91">    curl_global_cleanup();</a>
<a class="sourceLine" id="cb11-92" title="92">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb11-93" title="93">}</a></code></pre></div>
<h2 id="inotify-1"><code>inotify</code></h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb12-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="pp">#include </span><span class="im">&lt;sys/inotify.h&gt;</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb12-8" title="8"></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="dt">const</span> <span class="dt">char</span> filename[] = <span class="st">&quot;file.lock&quot;</span>;</a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb12-12" title="12">    <span class="dt">int</span> lockFD;</a>
<a class="sourceLine" id="cb12-13" title="13">    <span class="dt">bool</span> our_turn = false;</a>
<a class="sourceLine" id="cb12-14" title="14"></a>
<a class="sourceLine" id="cb12-15" title="15">    <span class="cf">while</span>( !our_turn ) {</a>
<a class="sourceLine" id="cb12-16" title="16">        lockFD = open( filename, O_CREAT | O_EXCL | O_TRUNC );</a>
<a class="sourceLine" id="cb12-17" title="17">        <span class="cf">if</span> ( lockFD == -<span class="dv">1</span> ) {</a>
<a class="sourceLine" id="cb12-18" title="18">            printf( <span class="st">&quot;The lock file exists and process %ld will wait its turn...</span><span class="sc">\n</span><span class="st">&quot;</span>, getpid() );</a>
<a class="sourceLine" id="cb12-19" title="19">            <span class="dt">int</span> notifyFD = inotify_init( );</a>
<a class="sourceLine" id="cb12-20" title="20">            <span class="dt">uint32_t</span> watched = inotify_add_watch( notifyFD, filename, IN_DELETE_SELF );</a>
<a class="sourceLine" id="cb12-21" title="21"></a>
<a class="sourceLine" id="cb12-22" title="22">            <span class="co">/* Read the file descriptor for the notify -- we get blocked here</span></a>
<a class="sourceLine" id="cb12-23" title="23"><span class="co">               until there&#39;s an event that we want */</span></a>
<a class="sourceLine" id="cb12-24" title="24">            <span class="dt">int</span> buffer_size = <span class="kw">sizeof</span>( <span class="kw">struct</span> inotify_event ) + strlen( filename ) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb12-25" title="25">            <span class="dt">char</span>* event_buffer = malloc( buffer_size );</a>
<a class="sourceLine" id="cb12-26" title="26">            printf(<span class="st">&quot;Setup complete, waiting for event...</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb12-27" title="27">            read( notifyFD, event_buffer, buffer_size );</a>
<a class="sourceLine" id="cb12-28" title="28"></a>
<a class="sourceLine" id="cb12-29" title="29">            <span class="kw">struct</span> inotify_event* event = (<span class="kw">struct</span> inotify_event*) event_buffer;</a>
<a class="sourceLine" id="cb12-30" title="30">            <span class="co">/* Here we can look and see what arrived and decide what to do.</span></a>
<a class="sourceLine" id="cb12-31" title="31"><span class="co">               In this example, we&#39;re only watching one file and one type</span></a>
<a class="sourceLine" id="cb12-32" title="32"><span class="co">               of event, so we don&#39;t need to make any decisions now */</span></a>
<a class="sourceLine" id="cb12-33" title="33"></a>
<a class="sourceLine" id="cb12-34" title="34">            printf(<span class="st">&quot;Event occurred!</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb12-35" title="35"></a>
<a class="sourceLine" id="cb12-36" title="36">            free( event_buffer );</a>
<a class="sourceLine" id="cb12-37" title="37">            inotify_rm_watch( lockFD, watched );</a>
<a class="sourceLine" id="cb12-38" title="38">            close( notifyFD );</a>
<a class="sourceLine" id="cb12-39" title="39">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb12-40" title="40">            <span class="dt">char</span>* pid = malloc( <span class="dv">32</span> );</a>
<a class="sourceLine" id="cb12-41" title="41">            memset( pid, <span class="dv">0</span>, <span class="dv">32</span> );</a>
<a class="sourceLine" id="cb12-42" title="42">            <span class="dt">int</span> bytes_of_pid = sprintf( pid, <span class="st">&quot;%ld&quot;</span>, getpid() );</a>
<a class="sourceLine" id="cb12-43" title="43"></a>
<a class="sourceLine" id="cb12-44" title="44">            write( lockFD, pid, bytes_of_pid );</a>
<a class="sourceLine" id="cb12-45" title="45">            free ( pid );</a>
<a class="sourceLine" id="cb12-46" title="46">            close( lockFD );</a>
<a class="sourceLine" id="cb12-47" title="47">            our_turn = true;</a>
<a class="sourceLine" id="cb12-48" title="48">        }</a>
<a class="sourceLine" id="cb12-49" title="49">    }</a>
<a class="sourceLine" id="cb12-50" title="50"></a>
<a class="sourceLine" id="cb12-51" title="51">    printf(<span class="st">&quot;Process %ld is in the area protected by file lock.</span><span class="sc">\n</span><span class="st">&quot;</span>, getpid());</a>
<a class="sourceLine" id="cb12-52" title="52">    remove( filename );</a>
<a class="sourceLine" id="cb12-53" title="53">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-54" title="54">}</a></code></pre></div>
<h2 id="pcond"><code>pcond</code></h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb13-1" title="1"><span class="pp">#include </span><span class="im">&lt;pthread.h&gt;</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="pp">#define NUM_THREADS  3</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="pp">#define COUNT_LIMIT 12</span></a>
<a class="sourceLine" id="cb13-7" title="7"></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="dt">int</span> count = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-9" title="9">pthread_mutex_t count_mutex;</a>
<a class="sourceLine" id="cb13-10" title="10">pthread_cond_t count_threshold_cv;</a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="dt">void</span>* inc_count( <span class="dt">void</span>* arg ) {</a>
<a class="sourceLine" id="cb13-13" title="13">  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; i++ ) {</a>
<a class="sourceLine" id="cb13-14" title="14">    pthread_mutex_lock( &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-15" title="15">    count++;</a>
<a class="sourceLine" id="cb13-16" title="16">    <span class="cf">if</span> ( count == COUNT_LIMIT ) {</a>
<a class="sourceLine" id="cb13-17" title="17">      printf( <span class="st">&quot;Condition Fulfilled!</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb13-18" title="18">      pthread_cond_signal( &amp;count_threshold_cv );</a>
<a class="sourceLine" id="cb13-19" title="19">      printf( <span class="st">&quot;Sent signal.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb13-20" title="20">    }</a>
<a class="sourceLine" id="cb13-21" title="21">    pthread_mutex_unlock( &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-22" title="22">  }</a>
<a class="sourceLine" id="cb13-23" title="23">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb13-24" title="24">}</a>
<a class="sourceLine" id="cb13-25" title="25"></a>
<a class="sourceLine" id="cb13-26" title="26"><span class="dt">void</span>* watch_count( <span class="dt">void</span> *arg ) {</a>
<a class="sourceLine" id="cb13-27" title="27">  pthread_mutex_lock( &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-28" title="28">  <span class="cf">if</span> ( count &lt; COUNT_LIMIT ) {</a>
<a class="sourceLine" id="cb13-29" title="29">    pthread_cond_wait( &amp;count_threshold_cv, &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-30" title="30">    printf( <span class="st">&quot;Watcher has woken up.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb13-31" title="31">    <span class="co">/* Do something useful here now that condition is fulfilled. */</span></a>
<a class="sourceLine" id="cb13-32" title="32">  }</a>
<a class="sourceLine" id="cb13-33" title="33">  pthread_mutex_unlock( &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-34" title="34">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb13-35" title="35">}</a>
<a class="sourceLine" id="cb13-36" title="36"></a>
<a class="sourceLine" id="cb13-37" title="37"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span> **argv ) {</a>
<a class="sourceLine" id="cb13-38" title="38">  pthread_t threads[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb13-39" title="39"></a>
<a class="sourceLine" id="cb13-40" title="40">  pthread_mutex_init( &amp;count_mutex, NULL );</a>
<a class="sourceLine" id="cb13-41" title="41">  pthread_cond_init ( &amp;count_threshold_cv, NULL );</a>
<a class="sourceLine" id="cb13-42" title="42"></a>
<a class="sourceLine" id="cb13-43" title="43">  pthread_create( &amp;threads[<span class="dv">0</span>], NULL, watch_count, NULL );</a>
<a class="sourceLine" id="cb13-44" title="44">  pthread_create( &amp;threads[<span class="dv">1</span>], NULL, inc_count, NULL );</a>
<a class="sourceLine" id="cb13-45" title="45">  pthread_create( &amp;threads[<span class="dv">2</span>], NULL, inc_count, NULL );</a>
<a class="sourceLine" id="cb13-46" title="46"></a>
<a class="sourceLine" id="cb13-47" title="47">  <span class="cf">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; NUM_THREADS; i++ ) {</a>
<a class="sourceLine" id="cb13-48" title="48">    pthread_join(threads[i], NULL);</a>
<a class="sourceLine" id="cb13-49" title="49">  }</a>
<a class="sourceLine" id="cb13-50" title="50"></a>
<a class="sourceLine" id="cb13-51" title="51">  pthread_mutex_destroy( &amp;count_mutex );</a>
<a class="sourceLine" id="cb13-52" title="52">  pthread_cond_destroy( &amp;count_threshold_cv );</a>
<a class="sourceLine" id="cb13-53" title="53">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb13-54" title="54">}</a></code></pre></div>
<h2 id="select"><code>select</code></h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb14-1" title="1"><span class="dt">void</span> listen_for_connections( <span class="dt">int</span> service1_sock, <span class="dt">int</span> service2_sock, <span class="dt">int</span> service3_sock ) {</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="dt">int</span> nfds = <span class="dv">1</span> + (service1_sock &gt; service<span class="dv">2</span><span class="er">_sock</span></a>
<a class="sourceLine" id="cb14-3" title="3">    ? service1_sock &gt; service3_sock ? service1_sock : service<span class="dv">3</span><span class="er">_sock</span></a>
<a class="sourceLine" id="cb14-4" title="4">    : service2_sock &gt; service3_sock ? service2_sock : service3_sock);</a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6">  fd_set s;</a>
<a class="sourceLine" id="cb14-7" title="7">  <span class="kw">struct</span> timeval tv;</a>
<a class="sourceLine" id="cb14-8" title="8">  printf( <span class="st">&quot;Going to start listening for socket events.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb14-9" title="9"></a>
<a class="sourceLine" id="cb14-10" title="10">  <span class="cf">while</span>( !quit ) {</a>
<a class="sourceLine" id="cb14-11" title="11"></a>
<a class="sourceLine" id="cb14-12" title="12">  FD_ZERO( &amp;s );</a>
<a class="sourceLine" id="cb14-13" title="13">  FD_SET( service1_sock, &amp;s );</a>
<a class="sourceLine" id="cb14-14" title="14">  FD_SET( service2_sock, &amp;s );</a>
<a class="sourceLine" id="cb14-15" title="15">  FD_SET( service3_sock, &amp;s );</a>
<a class="sourceLine" id="cb14-16" title="16"></a>
<a class="sourceLine" id="cb14-17" title="17">  tv.tv_sec = <span class="dv">30</span>;</a>
<a class="sourceLine" id="cb14-18" title="18">  tv.tv_usec = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb14-19" title="19"></a>
<a class="sourceLine" id="cb14-20" title="20">  <span class="dt">int</span> res = select( nfds, &amp;s, NULL, NULL, &amp;tv );</a>
<a class="sourceLine" id="cb14-21" title="21">  <span class="cf">if</span> ( res == -<span class="dv">1</span> ) { <span class="co">/* An error occurred */</span></a>
<a class="sourceLine" id="cb14-22" title="22">    printf( <span class="st">&quot;An error occurred in select(): %s.</span><span class="sc">\n</span><span class="st">&quot;</span>, strerror( errno ) );</a>
<a class="sourceLine" id="cb14-23" title="23">    quit = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb14-24" title="24">  } <span class="cf">else</span> <span class="cf">if</span> ( res == <span class="dv">0</span> ) { <span class="co">/* 0 sockets had events occur */</span></a>
<a class="sourceLine" id="cb14-25" title="25">    printf( <span class="st">&quot;Still waiting; nothing occurred recently.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb14-26" title="26">  } <span class="cf">else</span> { <span class="co">/* Things happened */</span></a>
<a class="sourceLine" id="cb14-27" title="27">    <span class="cf">if</span> ( FD_ISSET( service1_sock, &amp;s ) {</a>
<a class="sourceLine" id="cb14-28" title="28">      service1_activate( );</a>
<a class="sourceLine" id="cb14-29" title="29">    }</a>
<a class="sourceLine" id="cb14-30" title="30">    <span class="cf">if</span> ( FD_ISSET( service2_sock, &amp;s ) {</a>
<a class="sourceLine" id="cb14-31" title="31">      service2_activate( );</a>
<a class="sourceLine" id="cb14-32" title="32">    }</a>
<a class="sourceLine" id="cb14-33" title="33">    <span class="cf">if</span> ( FD_ISSET( service3_sock, &amp;s ) {</a>
<a class="sourceLine" id="cb14-34" title="34">      service3_activate( );</a>
<a class="sourceLine" id="cb14-35" title="35">    }</a>
<a class="sourceLine" id="cb14-36" title="36">  }</a>
<a class="sourceLine" id="cb14-37" title="37">}</a></code></pre></div>
<h2 id="poll"><code>poll</code></h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb15-1" title="1"><span class="dt">void</span> listen_for_connections( <span class="dt">int</span> service1_sock, <span class="dt">int</span> service2_sock, <span class="dt">int</span> service3_sock ) {</a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="kw">struct</span> pollfd fds[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb15-3" title="3">  fds[<span class="dv">0</span>].fd = service1_sock;</a>
<a class="sourceLine" id="cb15-4" title="4">  fds[<span class="dv">0</span>].events = POLLIN;</a>
<a class="sourceLine" id="cb15-5" title="5">  fds[<span class="dv">1</span>].fd = service2_sock;</a>
<a class="sourceLine" id="cb15-6" title="6">  fds[<span class="dv">1</span>].events = POLLIN;</a>
<a class="sourceLine" id="cb15-7" title="7">  fds[<span class="dv">2</span>].fd = service3_sock;</a>
<a class="sourceLine" id="cb15-8" title="8">  fds[<span class="dv">2</span>].events = POLLIN;</a>
<a class="sourceLine" id="cb15-9" title="9"></a>
<a class="sourceLine" id="cb15-10" title="10">  <span class="dt">int</span> timeout = <span class="dv">30</span> * <span class="dv">1000</span>; <span class="co">/* 30 seconds in ms */</span></a>
<a class="sourceLine" id="cb15-11" title="11">  printf( <span class="st">&quot;Going to start listening for socket events.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb15-12" title="12"></a>
<a class="sourceLine" id="cb15-13" title="13">  <span class="cf">while</span>( !quit ) {</a>
<a class="sourceLine" id="cb15-14" title="14">    <span class="dt">int</span> res = poll( &amp;fds, <span class="dv">3</span>, timeout );</a>
<a class="sourceLine" id="cb15-15" title="15">    <span class="cf">if</span> ( res == -<span class="dv">1</span> ) { <span class="co">/* An error occurred */</span></a>
<a class="sourceLine" id="cb15-16" title="16">      printf( <span class="st">&quot;An error occurred in select(): %s.</span><span class="sc">\n</span><span class="st">&quot;</span>, strerror( errno ) );</a>
<a class="sourceLine" id="cb15-17" title="17">      quit = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-18" title="18">    } <span class="cf">else</span> <span class="cf">if</span> ( res == <span class="dv">0</span> ) { <span class="co">/* 0 sockets had events occur */</span></a>
<a class="sourceLine" id="cb15-19" title="19">      printf( <span class="st">&quot;Still waiting; nothing occurred recently.</span><span class="sc">\n</span><span class="st">&quot;</span> );</a>
<a class="sourceLine" id="cb15-20" title="20">    } <span class="cf">else</span> { <span class="co">/* Things happened */</span></a>
<a class="sourceLine" id="cb15-21" title="21">      <span class="cf">if</span> ( fds[<span class="dv">0</span>].revents &amp; POLLIN ) {</a>
<a class="sourceLine" id="cb15-22" title="22">        service1_activate( );</a>
<a class="sourceLine" id="cb15-23" title="23">      }</a>
<a class="sourceLine" id="cb15-24" title="24">      <span class="cf">if</span> ( fds[<span class="dv">1</span>].revents &amp; POLLIN ) {</a>
<a class="sourceLine" id="cb15-25" title="25">        service2_activate( );</a>
<a class="sourceLine" id="cb15-26" title="26">      }</a>
<a class="sourceLine" id="cb15-27" title="27">      <span class="cf">if</span> ( fds[<span class="dv">2</span>].revents &amp; POLLIN ) {</a>
<a class="sourceLine" id="cb15-28" title="28">        service3_activate( );</a>
<a class="sourceLine" id="cb15-29" title="29">      }</a>
<a class="sourceLine" id="cb15-30" title="30">    }</a>
<a class="sourceLine" id="cb15-31" title="31">  }</a>
<a class="sourceLine" id="cb15-32" title="32">}</a></code></pre></div>
<h2 id="aiocb"><code>aiocb</code></h2>
<h3 id="simple">simple</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb16-1" title="1"><span class="dt">void</span> process( <span class="dt">char</span>* buffer ); <span class="co">/* Implementation not shown */</span></a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="dt">char</span>* buffer1 = malloc( MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="dt">char</span>* buffer2 = malloc( MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7">  <span class="dt">int</span> fd = open( argv[<span class="dv">1</span>], O_RDONLY );</a>
<a class="sourceLine" id="cb16-8" title="8">  memset( buffer1, <span class="dv">0</span>, MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb16-9" title="9">  read( fd, buffer1, MAX_SIZE );</a>
<a class="sourceLine" id="cb16-10" title="10">  close( fd );</a>
<a class="sourceLine" id="cb16-11" title="11"></a>
<a class="sourceLine" id="cb16-12" title="12">  <span class="cf">for</span> ( <span class="dt">int</span> i = <span class="dv">2</span>; i &lt; argc; i++ ) {</a>
<a class="sourceLine" id="cb16-13" title="13">    <span class="dt">int</span> nextFD = open( argv[i], O_RDONLY );</a>
<a class="sourceLine" id="cb16-14" title="14"></a>
<a class="sourceLine" id="cb16-15" title="15">    <span class="kw">struct</span> aiocb cb;</a>
<a class="sourceLine" id="cb16-16" title="16">    memset( &amp;cb, <span class="dv">0</span>, <span class="kw">sizeof</span>( <span class="kw">struct</span> aiocb ));</a>
<a class="sourceLine" id="cb16-17" title="17"></a>
<a class="sourceLine" id="cb16-18" title="18">    cb.aio_nbytes = MAX_SIZE;</a>
<a class="sourceLine" id="cb16-19" title="19">    cb.aio_fildes = nextFD;</a>
<a class="sourceLine" id="cb16-20" title="20">    cb.aio_offset = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb16-21" title="21">    memset( buffer2, <span class="dv">0</span>, MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb16-22" title="22">    cb.aio_buf = buffer2;</a>
<a class="sourceLine" id="cb16-23" title="23">    aio_read( &amp;cb );</a>
<a class="sourceLine" id="cb16-24" title="24"></a>
<a class="sourceLine" id="cb16-25" title="25">    process( buffer1 );</a>
<a class="sourceLine" id="cb16-26" title="26"></a>
<a class="sourceLine" id="cb16-27" title="27">    <span class="cf">while</span>( aio_error( &amp;cb ) == EINPROGRESS ) {</a>
<a class="sourceLine" id="cb16-28" title="28">      sleep( <span class="dv">1</span> );</a>
<a class="sourceLine" id="cb16-29" title="29">    }</a>
<a class="sourceLine" id="cb16-30" title="30">    aio_return( &amp;cb ); <span class="co">/* This frees some internal structures */</span></a>
<a class="sourceLine" id="cb16-31" title="31">    close( nextFD );</a>
<a class="sourceLine" id="cb16-32" title="32"></a>
<a class="sourceLine" id="cb16-33" title="33">    <span class="dt">char</span>* tmp = buffer1;</a>
<a class="sourceLine" id="cb16-34" title="34">    buffer1 = buffer2;</a>
<a class="sourceLine" id="cb16-35" title="35">    buffer2 = tmp;</a>
<a class="sourceLine" id="cb16-36" title="36">  }</a>
<a class="sourceLine" id="cb16-37" title="37">  process( buffer1 );</a>
<a class="sourceLine" id="cb16-38" title="38">  free( buffer1 );</a>
<a class="sourceLine" id="cb16-39" title="39">  free( buffer2 );</a>
<a class="sourceLine" id="cb16-40" title="40"></a>
<a class="sourceLine" id="cb16-41" title="41">  <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb16-42" title="42">}</a></code></pre></div>
<h3 id="callbacks">callbacks</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb17-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="pp">#include </span><span class="im">&lt;aio.h&gt;</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="pp">#include </span><span class="im">&lt;pthread.h&gt;</span></a>
<a class="sourceLine" id="cb17-9" title="9"></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="pp">#define MAX_SIZE 512</span></a>
<a class="sourceLine" id="cb17-11" title="11"></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="dt">void</span> worker( <span class="kw">union</span> sigval argument) {</a>
<a class="sourceLine" id="cb17-13" title="13">  <span class="dt">char</span>* buffer = (<span class="dt">char</span>*) argument.sival_ptr;</a>
<a class="sourceLine" id="cb17-14" title="14">  printf(<span class="st">&quot;Worker thread here. Buffer contains: %s</span><span class="sc">\n</span><span class="st">&quot;</span>, buffer);</a>
<a class="sourceLine" id="cb17-15" title="15">  free( buffer );</a>
<a class="sourceLine" id="cb17-16" title="16">}</a>
<a class="sourceLine" id="cb17-17" title="17"></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="dt">int</span> main( <span class="dt">int</span> argc, <span class="dt">char</span>** argv ) {</a>
<a class="sourceLine" id="cb17-19" title="19">  <span class="dt">char</span>* buffer = malloc( MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb17-20" title="20"></a>
<a class="sourceLine" id="cb17-21" title="21">  <span class="dt">int</span> fd = open( <span class="st">&quot;example.txt&quot;</span>, O_RDONLY );</a>
<a class="sourceLine" id="cb17-22" title="22">  memset( buffer, <span class="dv">0</span>, MAX_SIZE * <span class="kw">sizeof</span>( <span class="dt">char</span> ));</a>
<a class="sourceLine" id="cb17-23" title="23">  <span class="kw">struct</span> aiocb cb;</a>
<a class="sourceLine" id="cb17-24" title="24">  memset( &amp;cb, <span class="dv">0</span>, <span class="kw">sizeof</span>( <span class="kw">struct</span> aiocb ));</a>
<a class="sourceLine" id="cb17-25" title="25"></a>
<a class="sourceLine" id="cb17-26" title="26">  cb.aio_nbytes = MAX_SIZE;</a>
<a class="sourceLine" id="cb17-27" title="27">  cb.aio_fildes = fd;</a>
<a class="sourceLine" id="cb17-28" title="28">  cb.aio_offset = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb17-29" title="29">  cb.aio_buf = buffer;</a>
<a class="sourceLine" id="cb17-30" title="30">  cb.aio_sigevent.sigev_notify = SIGEV_THREAD;</a>
<a class="sourceLine" id="cb17-31" title="31">  cb.aio_sigevent.sigev_notify_function = worker;</a>
<a class="sourceLine" id="cb17-32" title="32">  cb.aio_sigevent.sigev_value.sival_ptr = buffer;</a>
<a class="sourceLine" id="cb17-33" title="33"></a>
<a class="sourceLine" id="cb17-34" title="34">  aio_read( &amp;cb );</a>
<a class="sourceLine" id="cb17-35" title="35"></a>
<a class="sourceLine" id="cb17-36" title="36">  pthread_exit( NULL );</a>
<a class="sourceLine" id="cb17-37" title="37">}</a></code></pre></div>
<h2 id="libevent"><code>libevent</code></h2>
<h3 id="no-buffer">no buffer</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb18-1" title="1"><span class="dt">void</span> cb_func( evutil_socket_t fd, <span class="dt">short</span> what, <span class="dt">void</span> *arg ) {</a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="dt">const</span> <span class="dt">char</span> *data = arg;</a>
<a class="sourceLine" id="cb18-3" title="3">  printf(<span class="st">&quot;Got an event on socket %d:%s%s%s%s [%s]&quot;</span>,</a>
<a class="sourceLine" id="cb18-4" title="4">      (<span class="dt">int</span>) fd,</a>
<a class="sourceLine" id="cb18-5" title="5">      (what&amp;EV_TIMEOUT) ? <span class="st">&quot; timeout&quot;</span> : <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb18-6" title="6">      (what&amp;EV_READ)    ? <span class="st">&quot; read&quot;</span> : <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb18-7" title="7">      (what&amp;EV_WRITE)   ? <span class="st">&quot; write&quot;</span> : <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb18-8" title="8">      (what&amp;EV_SIGNAL)  ? <span class="st">&quot; signal&quot;</span> : <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb18-9" title="9">      data);</a>
<a class="sourceLine" id="cb18-10" title="10">}</a>
<a class="sourceLine" id="cb18-11" title="11"></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="dt">void</span> main_loop( evutil_socket_t fd1, evutil_socket_t fd2 ){</a>
<a class="sourceLine" id="cb18-13" title="13">  <span class="kw">struct</span> event *ev1, *ev2;</a>
<a class="sourceLine" id="cb18-14" title="14">  <span class="kw">struct</span> timeval five_seconds = {<span class="dv">5</span>,<span class="dv">0</span>};</a>
<a class="sourceLine" id="cb18-15" title="15">  <span class="kw">struct</span> event_base *base = event_base_new();</a>
<a class="sourceLine" id="cb18-16" title="16"></a>
<a class="sourceLine" id="cb18-17" title="17">  <span class="co">/* The caller has already set up fd1, fd2 somehow, and make them nonblocking. */</span></a>
<a class="sourceLine" id="cb18-18" title="18"></a>
<a class="sourceLine" id="cb18-19" title="19">  ev1 = event_new(base, fd1, EV_TIMEOUT|EV_READ|EV_PERSIST, cb_func,(<span class="dt">char</span>*)<span class="st">&quot;Reading event&quot;</span>);</a>
<a class="sourceLine" id="cb18-20" title="20">  ev2 = event_new(base, fd2, EV_WRITE|EV_PERSIST, cb_func, (<span class="dt">char</span>*)<span class="st">&quot;Writing event&quot;</span>);</a>
<a class="sourceLine" id="cb18-21" title="21"></a>
<a class="sourceLine" id="cb18-22" title="22">  event_add(ev1, &amp;five_seconds);</a>
<a class="sourceLine" id="cb18-23" title="23">  event_add(ev2, NULL);</a>
<a class="sourceLine" id="cb18-24" title="24">  event_base_dispatch(base);</a>
<a class="sourceLine" id="cb18-25" title="25">}</a></code></pre></div>
<h3 id="buffered">buffered</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb19-1" title="1"><span class="pp">#include </span><span class="im">&lt;event2/event.h&gt;</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="pp">#include </span><span class="im">&lt;event2/bufferevent.h&gt;</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="dt">void</span> eventcb(<span class="kw">struct</span> bufferevent *bev, <span class="dt">short</span> events, <span class="dt">void</span> *ptr) {</a>
<a class="sourceLine" id="cb19-7" title="7">  <span class="cf">if</span> (events &amp; BEV_EVENT_CONNECTED) {</a>
<a class="sourceLine" id="cb19-8" title="8">       <span class="co">/* We&#39;re connected to 127.0.0.1:8080.   Ordinarily we&#39;d do</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co">          something here, like start reading or writing. */</span></a>
<a class="sourceLine" id="cb19-10" title="10">  } <span class="cf">else</span> <span class="cf">if</span> (events &amp; BEV_EVENT_ERROR) {</a>
<a class="sourceLine" id="cb19-11" title="11">       <span class="co">/* An error occured while connecting. */</span></a>
<a class="sourceLine" id="cb19-12" title="12">  }</a>
<a class="sourceLine" id="cb19-13" title="13">}</a>
<a class="sourceLine" id="cb19-14" title="14"></a>
<a class="sourceLine" id="cb19-15" title="15"><span class="dt">int</span> main_loop( ) {</a>
<a class="sourceLine" id="cb19-16" title="16">  <span class="kw">struct</span> event_base *base;</a>
<a class="sourceLine" id="cb19-17" title="17">  <span class="kw">struct</span> bufferevent *bev;</a>
<a class="sourceLine" id="cb19-18" title="18">  <span class="kw">struct</span> sockaddr_in sin;</a>
<a class="sourceLine" id="cb19-19" title="19"></a>
<a class="sourceLine" id="cb19-20" title="20">  base = event_base_new();</a>
<a class="sourceLine" id="cb19-21" title="21"></a>
<a class="sourceLine" id="cb19-22" title="22">  memset(&amp;sin, <span class="dv">0</span>, <span class="kw">sizeof</span>(sin));</a>
<a class="sourceLine" id="cb19-23" title="23">  sin.sin_family = AF_INET;</a>
<a class="sourceLine" id="cb19-24" title="24">  sin.sin_addr.s_addr = htonl(<span class="bn">0x7f000001</span>); <span class="co">/* 127.0.0.1 */</span></a>
<a class="sourceLine" id="cb19-25" title="25">  sin.sin_port = htons(<span class="dv">8080</span>); <span class="co">/* Port 8080 */</span></a>
<a class="sourceLine" id="cb19-26" title="26"></a>
<a class="sourceLine" id="cb19-27" title="27">  bev = bufferevent_socket_new(base, -<span class="dv">1</span>, BEV_OPT_CLOSE_ON_FREE);</a>
<a class="sourceLine" id="cb19-28" title="28"></a>
<a class="sourceLine" id="cb19-29" title="29">  bufferevent_setcb(bev, NULL, NULL, eventcb, NULL);</a>
<a class="sourceLine" id="cb19-30" title="30"></a>
<a class="sourceLine" id="cb19-31" title="31">  <span class="cf">if</span> (bufferevent_socket_connect(bev,</a>
<a class="sourceLine" id="cb19-32" title="32">      (<span class="kw">struct</span> sockaddr *)&amp;sin, <span class="kw">sizeof</span>(sin)) &lt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb19-33" title="33">      <span class="co">/* Error starting connection */</span></a>
<a class="sourceLine" id="cb19-34" title="34">      bufferevent_free(bev);</a>
<a class="sourceLine" id="cb19-35" title="35">      <span class="cf">return</span> -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb19-36" title="36">  }</a>
<a class="sourceLine" id="cb19-37" title="37"></a>
<a class="sourceLine" id="cb19-38" title="38">  event_base_dispatch(base);</a>
<a class="sourceLine" id="cb19-39" title="39">  <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb19-40" title="40">}</a></code></pre></div>
</body>
</html>
